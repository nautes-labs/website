<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>执行一条流水线 | Nautes</title>
    <meta name="generator" content="VuePress 1.9.9">
    
    <meta name="description" content="Kubernets 原生的一站式开发者平台">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.c2c28341.css" as="style"><link rel="preload" href="/assets/js/app.fc750a70.js" as="script"><link rel="preload" href="/assets/js/2.5cda13a8.js" as="script"><link rel="preload" href="/assets/js/60.5faf93c2.js" as="script"><link rel="prefetch" href="/assets/js/10.954f943b.js"><link rel="prefetch" href="/assets/js/11.9cd35a8a.js"><link rel="prefetch" href="/assets/js/12.debc7c72.js"><link rel="prefetch" href="/assets/js/13.dee35591.js"><link rel="prefetch" href="/assets/js/14.2a696c45.js"><link rel="prefetch" href="/assets/js/15.e37f3143.js"><link rel="prefetch" href="/assets/js/16.69ba4994.js"><link rel="prefetch" href="/assets/js/17.e9bfa8b1.js"><link rel="prefetch" href="/assets/js/18.9fd6e6d1.js"><link rel="prefetch" href="/assets/js/19.b4c42f8a.js"><link rel="prefetch" href="/assets/js/20.fecb0727.js"><link rel="prefetch" href="/assets/js/21.b2de65cb.js"><link rel="prefetch" href="/assets/js/22.305f3553.js"><link rel="prefetch" href="/assets/js/23.4e425205.js"><link rel="prefetch" href="/assets/js/24.6ac4a85f.js"><link rel="prefetch" href="/assets/js/25.76d4b3d3.js"><link rel="prefetch" href="/assets/js/26.f374973e.js"><link rel="prefetch" href="/assets/js/27.4c801238.js"><link rel="prefetch" href="/assets/js/28.773104f6.js"><link rel="prefetch" href="/assets/js/29.c3fd851b.js"><link rel="prefetch" href="/assets/js/3.bdfef2d9.js"><link rel="prefetch" href="/assets/js/30.973bc71d.js"><link rel="prefetch" href="/assets/js/31.b5842936.js"><link rel="prefetch" href="/assets/js/32.72b46c58.js"><link rel="prefetch" href="/assets/js/33.01d5cbc4.js"><link rel="prefetch" href="/assets/js/34.0dbcbadb.js"><link rel="prefetch" href="/assets/js/35.0d4a5e3c.js"><link rel="prefetch" href="/assets/js/36.a0574e4c.js"><link rel="prefetch" href="/assets/js/37.3fe72c83.js"><link rel="prefetch" href="/assets/js/38.cccd8d80.js"><link rel="prefetch" href="/assets/js/39.f9720bdc.js"><link rel="prefetch" href="/assets/js/4.18760c5a.js"><link rel="prefetch" href="/assets/js/40.3f1e8c84.js"><link rel="prefetch" href="/assets/js/41.cfda4e79.js"><link rel="prefetch" href="/assets/js/42.8dd3c223.js"><link rel="prefetch" href="/assets/js/43.c3a48afd.js"><link rel="prefetch" href="/assets/js/44.682d9710.js"><link rel="prefetch" href="/assets/js/45.96e09193.js"><link rel="prefetch" href="/assets/js/46.2dadb2ac.js"><link rel="prefetch" href="/assets/js/47.adbdeadd.js"><link rel="prefetch" href="/assets/js/48.fed11ce4.js"><link rel="prefetch" href="/assets/js/49.33b480fc.js"><link rel="prefetch" href="/assets/js/5.0a76c1bf.js"><link rel="prefetch" href="/assets/js/50.12715226.js"><link rel="prefetch" href="/assets/js/51.d6a261ff.js"><link rel="prefetch" href="/assets/js/52.2c32dd2b.js"><link rel="prefetch" href="/assets/js/53.444d4f5d.js"><link rel="prefetch" href="/assets/js/54.378deaa6.js"><link rel="prefetch" href="/assets/js/55.fc479b8e.js"><link rel="prefetch" href="/assets/js/56.b3d4010b.js"><link rel="prefetch" href="/assets/js/57.8de06c78.js"><link rel="prefetch" href="/assets/js/58.0cf26d90.js"><link rel="prefetch" href="/assets/js/59.2ea683d6.js"><link rel="prefetch" href="/assets/js/6.08b03b29.js"><link rel="prefetch" href="/assets/js/61.d657ae56.js"><link rel="prefetch" href="/assets/js/7.57051b0f.js"><link rel="prefetch" href="/assets/js/8.d80c16bd.js"><link rel="prefetch" href="/assets/js/9.568b32c0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c2c28341.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Nautes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/guide/user-guide/introduction.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/api/introduction.html" class="nav-link">
  API
</a></div><div class="nav-item"><a href="https://github.com/nautes-labs/nautes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/guide/user-guide/run-a-pipeline.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/guide/user-guide/run-a-pipeline.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  中文
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/guide/user-guide/introduction.html" class="nav-link">
  文档
</a></div><div class="nav-item"><a href="/api/introduction.html" class="nav-link">
  API
</a></div><div class="nav-item"><a href="https://github.com/nautes-labs/nautes" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/en/guide/user-guide/run-a-pipeline.html" class="nav-link">
  English
</a></li><li class="dropdown-item"><!----> <a href="/guide/user-guide/run-a-pipeline.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  中文
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>快速入门</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/user-guide/introduction.html" class="sidebar-link">概述</a></li><li><a href="/guide/user-guide/installation.html" class="sidebar-link">安装</a></li><li><a href="/guide/user-guide/run-a-pipeline.html" aria-current="page" class="active sidebar-link">执行一条流水线</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/guide/user-guide/run-a-pipeline.html#前提条件" class="sidebar-link">前提条件</a></li><li class="sidebar-sub-header"><a href="/guide/user-guide/run-a-pipeline.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/guide/user-guide/run-a-pipeline.html#注册运行时集群" class="sidebar-link">注册运行时集群</a></li><li class="sidebar-sub-header"><a href="/guide/user-guide/run-a-pipeline.html#初始化产品" class="sidebar-link">初始化产品</a></li><li class="sidebar-sub-header"><a href="/guide/user-guide/run-a-pipeline.html#执行流水线" class="sidebar-link">执行流水线</a></li><li class="sidebar-sub-header"><a href="/guide/user-guide/run-a-pipeline.html#查看流水线结果" class="sidebar-link">查看流水线结果</a></li><li class="sidebar-sub-header"><a href="/guide/user-guide/run-a-pipeline.html#常见问题" class="sidebar-link">常见问题</a></li></ul></li><li><a href="/guide/user-guide/deploy-an-application.html" class="sidebar-link">部署一个应用</a></li><li><a href="/guide/user-guide/clean-environment.html" class="sidebar-link">清理环境</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>用户指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/guide/user-guide/main-process.html" class="sidebar-link">主体流程</a></li><li><a href="/guide/user-guide/cluster.html" class="sidebar-link">注册运行时集群</a></li><li><a href="/guide/user-guide/product.html" class="sidebar-link">维护产品</a></li><li><a href="/guide/user-guide/project.html" class="sidebar-link">维护项目</a></li><li><a href="/guide/user-guide/code-repo.html" class="sidebar-link">维护代码库及其授权</a></li><li><a href="/guide/user-guide/environment.html" class="sidebar-link">维护环境</a></li><li><a href="/guide/user-guide/project-pipeline-runtime.html" class="sidebar-link">维护流水线运行时</a></li><li><a href="/guide/user-guide/deployment-runtime.html" class="sidebar-link">维护部署运行时</a></li><li><a href="/guide/user-guide/deployment-results.html" class="sidebar-link">查看流水线和部署结果</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="执行一条流水线"><a href="#执行一条流水线" class="header-anchor">#</a> 执行一条流水线</h1> <p>本文档描述了将一个全新的 Kubernetes 集群注册到 Nautes 中，并在此集群上执行一条 CI 流水线的过程。</p> <h2 id="前提条件"><a href="#前提条件" class="header-anchor">#</a> 前提条件</h2> <h3 id="注册-gitlab-账号"><a href="#注册-gitlab-账号" class="header-anchor">#</a> 注册 GitLab 账号</h3> <p>GitLab 安装完成后，您需要注册一个账号，并创建 <a href="https://docs.gitlab.com/ee/user/profile/personal_access_tokens.html" target="_blank" rel="noopener noreferrer">personal access token<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，设置 access token 的权限范围：api、read_api、read_repository 和 write_repository。</p> <p>此账号需要调用<a href="#%E6%B3%A8%E5%86%8C%E8%BF%90%E8%A1%8C%E6%97%B6%E9%9B%86%E7%BE%A4">管理集群</a>的 API，您需要将账号加入到租户配置库的成员列表，并保证此账号可以向 main 分支推送代码。</p> <h3 id="导入证书"><a href="#导入证书" class="header-anchor">#</a> 导入证书</h3> <p>如果您想使用 https 协议访问 Nautes API Server，请从<a href="/guide/user-guide/installation.html#查看安装结果">安装结果</a>下载 ca.crt 证书，并将 ca.crt 添加到执行 API 的服务器的授信证书列表。</p> <h3 id="准备服务器"><a href="#准备服务器" class="header-anchor">#</a> 准备服务器</h3> <p>您需要准备一台用于安装 Kubernetes 集群的服务器。如果您已经有一套 Kubernetes 集群（需要公网 IP），可以省略该步骤。</p> <p>下文将以阿里云为例描述如何准备服务器并安装一个 K3s 集群。</p> <p>创建 ECS 云服务器，详情参考 <a href="https://help.aliyun.com/document_detail/25422.html" target="_blank" rel="noopener noreferrer">云服务器 ECS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。服务器安装成功后，在服务器上安装 K3s，命令如下：</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token comment"># 替换 $PUBLIC_IP 为服务器的公网 IP</span>
<span class="token comment"># 替换 $DEX_SERVER 为安装机 /opt/nautes/out/service 目录下的 oauth_url</span>
<span class="token comment"># 下载安装机 /opt/nautes/out/pki 目录下的 ca.crt 证书，并存储到服务器的 /etc/ssl/certs/ 目录</span>
<span class="token function">curl</span> <span class="token parameter variable">-sfL</span> https://get.k3s.io <span class="token operator">|</span> <span class="token assign-left variable">INSTALL_K3S_VERSION</span><span class="token operator">=</span>v1.21.14+k3s1 <span class="token assign-left variable">INSTALL_K3S_EXEC</span><span class="token operator">=</span><span class="token string">&quot;--tls-san <span class="token variable">$PUBLIC_IP</span>&quot;</span> <span class="token function">sh</span> <span class="token parameter variable">-s</span> - server <span class="token parameter variable">--disable</span> servicelb <span class="token parameter variable">--disable</span> traefik <span class="token parameter variable">--disable</span> metrics-server --kube-apiserver-arg<span class="token operator">=</span>oidc-issuer-url<span class="token operator">=</span><span class="token variable">$DEX_SERVER</span> --kube-apiserver-arg<span class="token operator">=</span>oidc-client-id<span class="token operator">=</span>nautes --kube-apiserver-arg<span class="token operator">=</span>oidc-ca-file<span class="token operator">=</span>/etc/ssl/certs/ca.crt --kube-apiserver-arg<span class="token operator">=</span>oidc-groups-claim<span class="token operator">=</span>groups <span class="token parameter variable">-p</span> <span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.kube
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.kube
/bin/cp <span class="token parameter variable">-f</span> /etc/rancher/k3s/k3s.yaml <span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.kube/k3s-config
/bin/cp <span class="token parameter variable">-f</span> /etc/rancher/k3s/k3s.yaml <span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.kube/config
<span class="token builtin class-name">export</span> <span class="token assign-left variable">KUBECONFIG</span><span class="token operator">=</span><span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.kube/config
</code></pre></div><p>K3s安装完成后，需要开放入方向<code>6443</code>端口。详情参考 <a href="https://help.aliyun.com/document_detail/25471.htm?spm=a2c4g.353191.0.0.557a235djwgvC9#concept-sm5-2wz-xdb" target="_blank" rel="noopener noreferrer">安全组规则<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h2> <p>以阿里云为例描述在公有云部署 Nautes 的过程，详情参考 <a href="/guide/user-guide/installation.html">安装</a>。</p> <h2 id="注册运行时集群"><a href="#注册运行时集群" class="header-anchor">#</a> 注册运行时集群</h2> <p>注册运行时集群用于把已准备好的 Kubernetes 集群托管给租户管理集群，并由租户管理集群初始化集群的相关配置。初始化完成后的集群可以承载应用的运行时。</p> <p>注册运行时集群支持的集群形态包括物理集群和虚拟集群。</p> <p>当您的应用的运行时需要更高的性能、隔离性和可靠性时，建议使用<a href="#%E6%B3%A8%E5%86%8C%E7%89%A9%E7%90%86%E9%9B%86%E7%BE%A4">物理集群</a>。而对于其他环境，例如开发测试环境和试用环境等，可以使用<a href="#%E6%B3%A8%E5%86%8C%E8%99%9A%E6%8B%9F%E9%9B%86%E7%BE%A4">虚拟集群</a>。</p> <h3 id="注册物理集群"><a href="#注册物理集群" class="header-anchor">#</a> 注册物理集群</h3> <p>将命令行程序的代码库克隆到本地。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/nautes-labs/cli.git
</code></pre></div><p>替换位于相对路径 <code>examples/demo-cluster-physical-worker-pipeline.yaml</code> 下物理集群属性模板的变量，包括 <code>$suffix</code>、<code>$api-server</code>、<code>$cluster-ip</code> 和 <code>$kubeconfig</code>。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查看物理集群的 kubeconfig</span>
<span class="token function">cat</span> <span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.kube/config
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 物理集群属性模板</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 集群名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;physical-worker-$suffix&quot;</span>
  <span class="token comment"># 集群的 API SERVER URL。使用物理集群的 server 地址替换该变量</span>
  <span class="token key atrule">apiServer</span><span class="token punctuation">:</span> <span class="token string">&quot;$api-server&quot;</span>
  <span class="token comment"># 集群种类：目前只支持 kubernetes</span>
  <span class="token key atrule">clusterKind</span><span class="token punctuation">:</span> <span class="token string">&quot;kubernetes&quot;</span>
  <span class="token comment"># 集群类型：virtual或physical</span>
  <span class="token key atrule">clusterType</span><span class="token punctuation">:</span> <span class="token string">&quot;physical&quot;</span>
  <span class="token comment"># 集群用途：host或worker</span>
  <span class="token key atrule">usage</span><span class="token punctuation">:</span> <span class="token string">&quot;worker&quot;</span>
  <span class="token comment"># 运行时类型：流水线运行时</span>
  <span class="token key atrule">workerType</span><span class="token punctuation">:</span> <span class="token string">&quot;pipeline&quot;</span>
  <span class="token comment"># 主域名，使用物理集群的 IP 替换变量 $cluster-ip</span>
  <span class="token key atrule">primaryDomain</span><span class="token punctuation">:</span> <span class="token string">&quot;$cluster-ip.nip.io&quot;</span>
  <span class="token comment"># tekton 域名，使用物理集群的 IP 替换变量 $cluster-ip</span>
  <span class="token key atrule">tektonHost</span><span class="token punctuation">:</span> <span class="token string">&quot;tekton.physical-worker-$suffix.$cluster-ip.nip.io&quot;</span>
  <span class="token comment"># argocd 域名，使用物理集群的 IP 替换变量 $cluster-ip</span>
  <span class="token key atrule">argocdHost</span><span class="token punctuation">:</span> <span class="token string">&quot;argocd.physical-worker-$suffix.$cluster-ip.nip.io&quot;</span>
  <span class="token comment"># traefik 配置</span>
  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">httpNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;30080&quot;</span>
    <span class="token key atrule">httpsNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;30443&quot;</span>
  <span class="token comment"># 集群的 kubeconfig 文件内容：使用物理集群的 kubeconfig 替换该变量</span>
  <span class="token key atrule">kubeconfig</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    $kubeconfig</span>
</code></pre></div><p>替换变量后的物理集群属性示例如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;physical-worker-aliyun&quot;</span>
  <span class="token key atrule">apiServer</span><span class="token punctuation">:</span> <span class="token string">&quot;https://8.217.50.114:6443&quot;</span>
  <span class="token key atrule">clusterKind</span><span class="token punctuation">:</span> <span class="token string">&quot;kubernetes&quot;</span>
  <span class="token key atrule">clusterType</span><span class="token punctuation">:</span> <span class="token string">&quot;physical&quot;</span>
  <span class="token key atrule">usage</span><span class="token punctuation">:</span> <span class="token string">&quot;worker&quot;</span>
  <span class="token key atrule">workerType</span><span class="token punctuation">:</span> <span class="token string">&quot;pipeline&quot;</span>
  <span class="token key atrule">primaryDomain</span><span class="token punctuation">:</span> <span class="token string">&quot;8.217.50.114.nip.io&quot;</span>
  <span class="token key atrule">tektonHost</span><span class="token punctuation">:</span> <span class="token string">&quot;tekton.physical-worker-aliyun.8.217.50.114.nip.io&quot;</span>
  <span class="token key atrule">argocdHost</span><span class="token punctuation">:</span> <span class="token string">&quot;argocd.physical-worker-aliyun.8.217.50.114.nip.io&quot;</span>
  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">httpNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;30080&quot;</span>
    <span class="token key atrule">httpsNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;30443&quot;</span>
  <span class="token key atrule">kubeconfig</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJlRENDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUyT0RFeU9UQXdPVFV3SGhjTk1qTXdOREV5TURrd01UTTFXaGNOTXpNd05EQTVNRGt3TVRNMQpXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUyT0RFeU9UQXdPVFV3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFSMzRuTjVPWWhxb3MrekV1YXZsVDRleXE4ZFRVZ2pxcUdoN2Z6NkpMZEMKem1FN0cwZjE5K0hLcEw5cU1tSXVBaStRelBZZFNzWGJpR20rNjR0R0NuVkRvMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVUp0WVUxbkNvTXNNYWpVeUJGN3RVCndjZWJ6TW93Q2dZSUtvWkl6ajBFQXdJRFNRQXdSZ0loQU9hR2pWNlRpK2o1Yy9kWlV5a1pERml0OU9DdkFmZjEKWjJSVUJ6TkJTOUlhQWlFQTB1bzM2YUVGRnkvdWQ0eHREZnNkWmhYWmZOaXQ3c2N4SXREa1k5STlQUkU9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
        server: https://127.0.0.1:6443
      name: default
    contexts:
    - context:
        cluster: default
        user: default
      name: default
    current-context: default
    kind: Config
    preferences: {}
    users:
    - name: default
      user:
        client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJrVENDQVRlZ0F3SUJBZ0lJSjYyRGdFT3JiM3d3Q2dZSUtvWkl6ajBFQXdJd0l6RWhNQjhHQTFVRUF3d1kKYXpOekxXTnNhV1Z1ZEMxallVQXhOamd4TWprd01EazFNQjRYRFRJek1EUXhNakE1TURFek5Wb1hEVEkwTURReApNVEE1TURFek5Wb3dNREVYTUJVR0ExVUVDaE1PYzNsemRHVnRPbTFoYzNSbGNuTXhGVEFUQmdOVkJBTVRESE41CmMzUmxiVHBoWkcxcGJqQlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJJNnlLRlBKNENmS25BUFkKQ0Q5ZFVtZlZ5ekR2aFpEQUdhU1lYODVoWWRYZ0NKdmxHRmlad3dGN2ExKzEzdlQ5ZjE2MUJwSGhKTm9mYi9oeAozUVo1MWs2alNEQkdNQTRHQTFVZER3RUIvd1FFQXdJRm9EQVRCZ05WSFNVRUREQUtCZ2dyQmdFRkJRY0RBakFmCkJnTlZIU01FR0RBV2dCVHhiVTM2eC9iMnl3WU14SmpuUjF5L2w2cHZCREFLQmdncWhrak9QUVFEQWdOSUFEQkYKQWlFQS9rZ3FCOGJLZnNLSGNmaDBUSFQ2bTZNLzdrMzlNWmFGYlVCaE9GTzVDSW9DSURiRWNaeUxkc055R3lVVQpSTDl5K0hHcVJ3b1FTWGhOa1NrQjhlbkpsQTEzCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdFkyeHAKWlc1MExXTmhRREUyT0RFeU9UQXdPVFV3SGhjTk1qTXdOREV5TURrd01UTTFXaGNOTXpNd05EQTVNRGt3TVRNMQpXakFqTVNFd0h3WURWUVFEREJock0zTXRZMnhwWlc1MExXTmhRREUyT0RFeU9UQXdPVFV3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFTbnNEVkxLTU4xTWl4cHAwclRMRTBOVGdjamFRWFhmUmZmOThiOTRqd1gKYjRPNVh1aCtFclZwZ3BjamxRYjVZKzM0T1NwaG03TnVXWlA2OHBkUWhMTW5vMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVThXMU4rc2YyOXNzR0RNU1k1MGRjCnY1ZXFid1F3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQUtXSStXQ2wwRFlJME5oVDBzbDkwSVRHRW05V2EyaE0KQXV4UXkrcDVUcGpzQWlBdWxFd0NkK2lWYXNVY2VHa2I4WU81dlduQitaTVJmSU1rYWRHSGhpSmlrdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
        client-key-data: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU5ZZFVkaER2SlFXcVNSRzR0d3gzQ2I4amhnck1HZlVOMG1uajV5dTRWZ1RvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFanJJb1U4bmdKOHFjQTlnSVAxMVNaOVhMTU8rRmtNQVpwSmhmem1GaDFlQUltK1VZV0puRApBWHRyWDdYZTlQMS9YclVHa2VFazJoOXYrSEhkQm5uV1RnPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=</span>
</code></pre></div><p>下载 <a href="https://github.com/nautes-labs/cli/releases/tag/v0.3.0" target="_blank" rel="noopener noreferrer">命令行工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，执行以下命令以注册物理集群。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token comment"># examples/demo-cluster-physical-worker-pipeline.yaml 指在代码库中模板文件的相对路径</span>
<span class="token comment"># gitlab-access-token 指 GitLab access token</span>
<span class="token comment"># api-server-address 指 Nautes API Server 的访问地址</span>
nautes apply <span class="token parameter variable">-f</span> examples/demo-cluster-physical-worker-pipeline.yaml <span class="token parameter variable">-t</span> <span class="token variable">$gitlab</span>-access-token <span class="token parameter variable">-s</span> <span class="token variable">$api</span>-server-address
</code></pre></div><h3 id="注册虚拟集群"><a href="#注册虚拟集群" class="header-anchor">#</a> 注册虚拟集群</h3> <p>注册虚拟集群时需要先将物理集群注册为宿主集群，再在宿主集群上注册虚拟集群。</p> <p>将命令行程序的代码库克隆到本地。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/nautes-labs/cli.git
</code></pre></div><p>替换位于相对路径 <code>examples/demo-cluster-host.yaml</code> 下的宿主集群属性模板的变量，包括 <code>$suffix</code>、<code>$api-server</code> 和 <code>$kubeconfig</code>。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token comment"># 查看宿主集群的 kubeconfig</span>
<span class="token function">cat</span> <span class="token variable">${<span class="token environment constant">HOME</span>}</span>/.kube/config
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 宿主集群属性模板</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 集群名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;host-$suffix&quot;</span>
  <span class="token comment"># 集群的 API SERVER URL，使用宿主集群的 server 地址替换该变量</span>
  <span class="token key atrule">apiServer</span><span class="token punctuation">:</span> <span class="token string">&quot;$api-server&quot;</span>
  <span class="token comment"># 集群种类：目前只支持 kubernetes</span>
  <span class="token key atrule">clusterKind</span><span class="token punctuation">:</span> <span class="token string">&quot;kubernetes&quot;</span>
  <span class="token comment"># 集群类型：virtual或physical</span>
  <span class="token key atrule">clusterType</span><span class="token punctuation">:</span> <span class="token string">&quot;physical&quot;</span>
  <span class="token comment"># 集群用途：host或worker</span>
  <span class="token key atrule">usage</span><span class="token punctuation">:</span> <span class="token string">&quot;host&quot;</span>
  <span class="token comment"># 主域名，使用物理集群的 IP 替换变量 $cluster-ip</span>
  <span class="token key atrule">primaryDomain</span><span class="token punctuation">:</span> <span class="token string">&quot;$cluster-ip.nip.io&quot;</span>
  <span class="token comment"># traefik 配置</span>
  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">httpNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;30080&quot;</span>
    <span class="token key atrule">httpsNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;30443&quot;</span>
  <span class="token comment"># 集群的 kubeconfig 文件内容，使用宿主集群的 kubeconfig 替换该变量</span>
  <span class="token key atrule">kubeconfig</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    $kubeconfig</span>
</code></pre></div><p>替换变量后的宿主集群属性示例如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;host-aliyun&quot;</span>
  <span class="token key atrule">apiServer</span><span class="token punctuation">:</span> <span class="token string">&quot;https://8.217.50.114:6443&quot;</span>
  <span class="token key atrule">clusterKind</span><span class="token punctuation">:</span> <span class="token string">&quot;kubernetes&quot;</span>
  <span class="token key atrule">clusterType</span><span class="token punctuation">:</span> <span class="token string">&quot;physical&quot;</span>
  <span class="token key atrule">usage</span><span class="token punctuation">:</span> <span class="token string">&quot;host&quot;</span>
  <span class="token key atrule">primaryDomain</span><span class="token punctuation">:</span> <span class="token string">&quot;8.217.50.114.nip.io&quot;</span>
  <span class="token key atrule">traefik</span><span class="token punctuation">:</span>
    <span class="token key atrule">httpNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;30080&quot;</span>
    <span class="token key atrule">httpsNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;30443&quot;</span>
  <span class="token key atrule">kubeconfig</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJlRENDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdGMyVnkKZG1WeUxXTmhRREUyT0RFeU9UQXdPVFV3SGhjTk1qTXdOREV5TURrd01UTTFXaGNOTXpNd05EQTVNRGt3TVRNMQpXakFqTVNFd0h3WURWUVFEREJock0zTXRjMlZ5ZG1WeUxXTmhRREUyT0RFeU9UQXdPVFV3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFSMzRuTjVPWWhxb3MrekV1YXZsVDRleXE4ZFRVZ2pxcUdoN2Z6NkpMZEMKem1FN0cwZjE5K0hLcEw5cU1tSXVBaStRelBZZFNzWGJpR20rNjR0R0NuVkRvMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVUp0WVUxbkNvTXNNYWpVeUJGN3RVCndjZWJ6TW93Q2dZSUtvWkl6ajBFQXdJRFNRQXdSZ0loQU9hR2pWNlRpK2o1Yy9kWlV5a1pERml0OU9DdkFmZjEKWjJSVUJ6TkJTOUlhQWlFQTB1bzM2YUVGRnkvdWQ0eHREZnNkWmhYWmZOaXQ3c2N4SXREa1k5STlQUkU9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
        server: https://127.0.0.1:6443
      name: default
    contexts:
    - context:
        cluster: default
        user: default
      name: default
    current-context: default
    kind: Config
    preferences: {}
    users:
    - name: default
      user:
        client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJrVENDQVRlZ0F3SUJBZ0lJSjYyRGdFT3JiM3d3Q2dZSUtvWkl6ajBFQXdJd0l6RWhNQjhHQTFVRUF3d1kKYXpOekxXTnNhV1Z1ZEMxallVQXhOamd4TWprd01EazFNQjRYRFRJek1EUXhNakE1TURFek5Wb1hEVEkwTURReApNVEE1TURFek5Wb3dNREVYTUJVR0ExVUVDaE1PYzNsemRHVnRPbTFoYzNSbGNuTXhGVEFUQmdOVkJBTVRESE41CmMzUmxiVHBoWkcxcGJqQlpNQk1HQnlxR1NNNDlBZ0VHQ0NxR1NNNDlBd0VIQTBJQUJJNnlLRlBKNENmS25BUFkKQ0Q5ZFVtZlZ5ekR2aFpEQUdhU1lYODVoWWRYZ0NKdmxHRmlad3dGN2ExKzEzdlQ5ZjE2MUJwSGhKTm9mYi9oeAozUVo1MWs2alNEQkdNQTRHQTFVZER3RUIvd1FFQXdJRm9EQVRCZ05WSFNVRUREQUtCZ2dyQmdFRkJRY0RBakFmCkJnTlZIU01FR0RBV2dCVHhiVTM2eC9iMnl3WU14SmpuUjF5L2w2cHZCREFLQmdncWhrak9QUVFEQWdOSUFEQkYKQWlFQS9rZ3FCOGJLZnNLSGNmaDBUSFQ2bTZNLzdrMzlNWmFGYlVCaE9GTzVDSW9DSURiRWNaeUxkc055R3lVVQpSTDl5K0hHcVJ3b1FTWGhOa1NrQjhlbkpsQTEzCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJkekNDQVIyZ0F3SUJBZ0lCQURBS0JnZ3Foa2pPUFFRREFqQWpNU0V3SHdZRFZRUUREQmhyTTNNdFkyeHAKWlc1MExXTmhRREUyT0RFeU9UQXdPVFV3SGhjTk1qTXdOREV5TURrd01UTTFXaGNOTXpNd05EQTVNRGt3TVRNMQpXakFqTVNFd0h3WURWUVFEREJock0zTXRZMnhwWlc1MExXTmhRREUyT0RFeU9UQXdPVFV3V1RBVEJnY3Foa2pPClBRSUJCZ2dxaGtqT1BRTUJCd05DQUFTbnNEVkxLTU4xTWl4cHAwclRMRTBOVGdjamFRWFhmUmZmOThiOTRqd1gKYjRPNVh1aCtFclZwZ3BjamxRYjVZKzM0T1NwaG03TnVXWlA2OHBkUWhMTW5vMEl3UURBT0JnTlZIUThCQWY4RQpCQU1DQXFRd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBZEJnTlZIUTRFRmdRVThXMU4rc2YyOXNzR0RNU1k1MGRjCnY1ZXFid1F3Q2dZSUtvWkl6ajBFQXdJRFNBQXdSUUloQUtXSStXQ2wwRFlJME5oVDBzbDkwSVRHRW05V2EyaE0KQXV4UXkrcDVUcGpzQWlBdWxFd0NkK2lWYXNVY2VHa2I4WU81dlduQitaTVJmSU1rYWRHSGhpSmlrdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
        client-key-data: LS0tLS1CRUdJTiBFQyBQUklWQVRFIEtFWS0tLS0tCk1IY0NBUUVFSU5ZZFVkaER2SlFXcVNSRzR0d3gzQ2I4amhnck1HZlVOMG1uajV5dTRWZ1RvQW9HQ0NxR1NNNDkKQXdFSG9VUURRZ0FFanJJb1U4bmdKOHFjQTlnSVAxMVNaOVhMTU8rRmtNQVpwSmhmem1GaDFlQUltK1VZV0puRApBWHRyWDdYZTlQMS9YclVHa2VFazJoOXYrSEhkQm5uV1RnPT0KLS0tLS1FTkQgRUMgUFJJVkFURSBLRVktLS0tLQo=</span>
</code></pre></div><p>下载 <a href="https://github.com/nautes-labs/cli/releases/tag/v0.3.0" target="_blank" rel="noopener noreferrer">命令行工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，执行以下命令，将注册宿主集群。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token comment"># examples/demo-cluster-host.yaml 指在代码库中模板文件的相对路径</span>
<span class="token comment"># gitlab-access-token 指 GitLab access token</span>
<span class="token comment"># api-server-address 指 Nautes API Server 的访问地址</span>
nautes apply <span class="token parameter variable">-f</span> examples/demo-cluster-host.yaml <span class="token parameter variable">-t</span> <span class="token variable">$gitlab</span>-access-token <span class="token parameter variable">-s</span> <span class="token variable">$api</span>-server-address
</code></pre></div><p>替换位于相对路径 <code>examples/demo-cluster-virtual-worker-pipeline.yaml</code> 下的虚拟集群属性模板的变量，包括 <code>$suffix</code>、<code>$api-server</code>、<code>$cluster-ip</code>、<code>$host-cluster</code> 和 <code>$api-server-port</code>。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 虚拟集群属性模板</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 集群名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;vcluster-$suffix&quot;</span>
  <span class="token comment"># 集群的 API SERVER URL，使用 https://$hostcluster-ip:$api-server-port 格式替换参数，其中 $hostcluster-ip 指宿主集群的IP，$api-server-port 指虚拟集群的 API Server 端口</span>
  <span class="token key atrule">apiServer</span><span class="token punctuation">:</span> <span class="token string">&quot;$api-server&quot;</span>
  <span class="token comment"># 集群种类：目前只支持 kubernetes</span>
  <span class="token key atrule">clusterKind</span><span class="token punctuation">:</span> <span class="token string">&quot;kubernetes&quot;</span>
  <span class="token comment"># 集群类型：virtual或physical</span>
  <span class="token key atrule">clusterType</span><span class="token punctuation">:</span> <span class="token string">&quot;virtual&quot;</span>
  <span class="token comment"># 集群用途：host或worker</span>
  <span class="token key atrule">usage</span><span class="token punctuation">:</span> <span class="token string">&quot;worker&quot;</span>
  <span class="token comment"># 运行时类型：流水线运行时</span>
  <span class="token key atrule">workerType</span><span class="token punctuation">:</span> <span class="token string">&quot;pipeline&quot;</span>
  <span class="token comment"># 所属宿主集群：virtual类型集群才有此属性，使用宿主集群的名称替换参数</span>
  <span class="token key atrule">hostCluster</span><span class="token punctuation">:</span> <span class="token string">&quot;$host-cluster&quot;</span>
  <span class="token comment"># 主域名，使用宿主集群的 IP 替换变量 $cluster-ip</span>
  <span class="token key atrule">primaryDomain</span><span class="token punctuation">:</span> <span class="token string">&quot;$cluster-ip.nip.io&quot;</span>
  <span class="token comment"># tekton 域名，使用宿主集群的 IP 替换变量 $cluster-ip</span>
  <span class="token key atrule">tektonHost</span><span class="token punctuation">:</span> <span class="token string">&quot;tekton.vcluster-$suffix.$cluster-ip.nip.io&quot;</span>
  <span class="token comment"># argocd 域名，使用宿主集群的 IP 替换变量 $cluster-ip</span>
  <span class="token key atrule">argocdHost</span><span class="token punctuation">:</span> <span class="token string">&quot;argocd.vcluster-$suffix.$cluster-ip.nip.io&quot;</span>
  <span class="token comment"># 虚拟集群配置：virtual类型集群才有此属性</span>
  <span class="token key atrule">vcluster</span><span class="token punctuation">:</span> 
    <span class="token comment"># API SERVER 端口号</span>
    <span class="token key atrule">httpsNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;$api-server-port&quot;</span>
</code></pre></div><p>替换变量后的虚拟集群属性示例如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">&quot;vcluster-aliyun&quot;</span>
  <span class="token key atrule">apiServer</span><span class="token punctuation">:</span> <span class="token string">&quot;https://8.217.50.114:31456&quot;</span>
  <span class="token key atrule">clusterKind</span><span class="token punctuation">:</span> <span class="token string">&quot;kubernetes&quot;</span>
  <span class="token key atrule">clusterType</span><span class="token punctuation">:</span> <span class="token string">&quot;virtual&quot;</span>
  <span class="token key atrule">usage</span><span class="token punctuation">:</span> <span class="token string">&quot;worker&quot;</span>
  <span class="token key atrule">workerType</span><span class="token punctuation">:</span> <span class="token string">&quot;pipeline&quot;</span>
  <span class="token key atrule">hostCluster</span><span class="token punctuation">:</span> <span class="token string">&quot;host-aliyun&quot;</span>
  <span class="token key atrule">primaryDomain</span><span class="token punctuation">:</span> <span class="token string">&quot;8.217.50.114.nip.io&quot;</span>
  <span class="token key atrule">tektonHost</span><span class="token punctuation">:</span> <span class="token string">&quot;tekton.vcluster-aliyun.8.217.50.114.nip.io&quot;</span>
  <span class="token key atrule">argocdHost</span><span class="token punctuation">:</span> <span class="token string">&quot;argocd.vcluster-aliyun.8.217.50.114.nip.io&quot;</span>
  <span class="token key atrule">vcluster</span><span class="token punctuation">:</span> 
    <span class="token key atrule">httpsNodePort</span><span class="token punctuation">:</span> <span class="token string">&quot;31456&quot;</span>
</code></pre></div><p>执行以下命令，将注册该虚拟集群。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token comment"># examples/demo-cluster-virtual-worker-pipeline.yaml 指在代码库中模板文件的相对路径</span>
<span class="token comment"># gitlab-access-token 指 GitLab access token</span>
<span class="token comment"># api-server-address 指 Nautes API Server 的访问地址</span>
nautes apply <span class="token parameter variable">-f</span> examples/demo-cluster-virtual-worker-pipeline.yaml <span class="token parameter variable">-t</span> <span class="token variable">$gitlab</span>-access-token <span class="token parameter variable">-s</span> <span class="token variable">$api</span>-server-address
</code></pre></div><h2 id="初始化产品"><a href="#初始化产品" class="header-anchor">#</a> 初始化产品</h2> <p>初始化产品是指创建 Nautes 产品模型中的各个实体，并在运行时集群中初始化一套用于执行流水线的资源，包括 namespace、serviceaccount、secret、以及 argoevents 和 tekton 相关资源等。</p> <p>下文将描述通过命令行初始化产品的相关实体，包括产品、项目、代码库、代码库权限、环境以及流水线运行时等。</p> <p>将命令行程序的代码库克隆到本地。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/nautes-labs/cli.git
</code></pre></div><p>替换位于相对路径 <code>examples/demo-product.yaml</code> 下模板的变量，包括 <code>$suffix</code>。</p> <blockquote><p>这里创建了两个代码库：“源码库”是用于存储项目源码和流水线配置文件，“部署配置库”是用于存储项目的部署清单文件。</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token comment"># 产品</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Product
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
  <span class="token key atrule">git</span><span class="token punctuation">:</span>
    <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
      <span class="token comment"># 产品名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
      <span class="token comment"># 产品路径</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
      <span class="token key atrule">visibility</span><span class="token punctuation">:</span> private
      <span class="token key atrule">description</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
      <span class="token key atrule">parentID</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token punctuation">---</span>
<span class="token comment"># 项目</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;nautes.resource.nautes.io/v1alpha1&quot;</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Project
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 项目名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 项目的所属产品</span>
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
  <span class="token key atrule">language</span><span class="token punctuation">:</span> golang
<span class="token punctuation">---</span>
<span class="token comment"># 源码库</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CodeRepo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 代码库名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token key atrule">codeRepoProvider</span><span class="token punctuation">:</span> gitlab
  <span class="token key atrule">deploymentRuntime</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">pipelineRuntime</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token comment"># 代码库的所属产品</span>
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 代码库的所属项目</span>
  <span class="token key atrule">project</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>
    <span class="token key atrule">events</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;push_events&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">git</span><span class="token punctuation">:</span>
    <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
      <span class="token comment"># 代码库的名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
      <span class="token comment"># 代码库的路径</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix 
      <span class="token comment"># 代码库的可见性，例如：private、public</span>
      <span class="token key atrule">visibility</span><span class="token punctuation">:</span> private
      <span class="token key atrule">description</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
<span class="token punctuation">---</span>
<span class="token comment"># 部署配置库</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CodeRepo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 代码库名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token key atrule">codeRepoProvider</span><span class="token punctuation">:</span> gitlab
  <span class="token key atrule">deploymentRuntime</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">pipelineRuntime</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token comment"># 代码库的所属产品</span>
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>
    <span class="token key atrule">events</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;push_events&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">git</span><span class="token punctuation">:</span>
    <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
      <span class="token comment"># 代码库的名称</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
      <span class="token comment"># 代码库的路径</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix 
      <span class="token comment"># 代码库的可见性，例如：private、public</span>
      <span class="token key atrule">visibility</span><span class="token punctuation">:</span> private
      <span class="token key atrule">description</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
</code></pre></div><p>替换变量后的文件示例如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Product
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">git</span><span class="token punctuation">:</span>
    <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
      <span class="token key atrule">path</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
      <span class="token key atrule">visibility</span><span class="token punctuation">:</span> private
      <span class="token key atrule">description</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
      <span class="token key atrule">parentID</span><span class="token punctuation">:</span> <span class="token number">0</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">&quot;nautes.resource.nautes.io/v1alpha1&quot;</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Project
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">language</span><span class="token punctuation">:</span> golang
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CodeRepo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">codeRepoProvider</span><span class="token punctuation">:</span> gitlab
  <span class="token key atrule">deploymentRuntime</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">pipelineRuntime</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">project</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>
    <span class="token key atrule">events</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;push_events&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">git</span><span class="token punctuation">:</span>
    <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
      <span class="token key atrule">path</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart 
      <span class="token key atrule">visibility</span><span class="token punctuation">:</span> private
      <span class="token key atrule">description</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CodeRepo
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">codeRepoProvider</span><span class="token punctuation">:</span> gitlab
  <span class="token key atrule">deploymentRuntime</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">pipelineRuntime</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">webhook</span><span class="token punctuation">:</span>
    <span class="token key atrule">events</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;push_events&quot;</span><span class="token punctuation">]</span>
  <span class="token key atrule">git</span><span class="token punctuation">:</span>
    <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
      <span class="token key atrule">path</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart 
      <span class="token key atrule">visibility</span><span class="token punctuation">:</span> private
      <span class="token key atrule">description</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
</code></pre></div><p>替换位于相对路径 <code>examples/demo-pipeline.yaml</code> 下模板的变量，包括 <code>$suffix</code>、<code>$pipeline-runtime-cluster</code>。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token comment"># 开发环境</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Environment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 环镜名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 环境的所属产品</span>
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 环境关联的运行时集群</span>
  <span class="token key atrule">cluster</span><span class="token punctuation">:</span> $pipeline<span class="token punctuation">-</span>runtime<span class="token punctuation">-</span>cluster
  <span class="token comment"># 环境类型</span>
  <span class="token key atrule">envType</span><span class="token punctuation">:</span> dev
<span class="token punctuation">---</span>
<span class="token comment"># 部署配置库授权给流水线</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CodeRepoBinding
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 代码库的所属产品</span>
  <span class="token key atrule">productName</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepobinding<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>pipeline<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 被授权的代码库</span>
  <span class="token key atrule">coderepo</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 授权给产品</span>
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 授权给项目</span>
  <span class="token key atrule">projects</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> project<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 授予的权限：readonly, readwrite</span>
  <span class="token key atrule">permissions</span><span class="token punctuation">:</span> readwrite
<span class="token punctuation">---</span>
<span class="token comment"># 流水线运行时</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ProjectPipelineRuntime
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment"># 流水线运行时的名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pr<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 流水线运行时的所属产品</span>
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 流水线运行时的所属项目</span>
  <span class="token key atrule">project</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 流水线配置的源码库</span>
  <span class="token key atrule">pipelineSource</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 流水线的定义</span>
  <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
    <span class="token comment"># 流水线名称</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pipeline<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
    <span class="token comment"># 流水线资源的标签</span>
    <span class="token key atrule">label</span><span class="token punctuation">:</span> main
    <span class="token comment"># 流水线配置文件的路径</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> pipelines/main.yaml
  <span class="token comment"># 承载部署运行时的环境</span>
  <span class="token key atrule">destination</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
  <span class="token comment"># 触发流水线的事件源</span>
  <span class="token key atrule">eventSources</span><span class="token punctuation">:</span>
    <span class="token comment"># 事件源名称</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook
    <span class="token comment"># gitlab 事件源</span>
    <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
      <span class="token comment"># 代码库名称</span>
      <span class="token key atrule">repoName</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
      <span class="token comment"># 产生事件的代码库分支，&quot;*&quot;表示该事件源接收所有分支的事件</span>
      <span class="token key atrule">revision</span><span class="token punctuation">:</span> main
      <span class="token comment"># 该事件源接收的代码库的事件类型</span>
      <span class="token key atrule">events</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> push_events
  <span class="token comment"># 流水线相关资源的隔离性定义，shared（默认）或 exclusive</span>
  <span class="token key atrule">isolation</span><span class="token punctuation">:</span> exclusive
  <span class="token comment"># 关联流水线和事件源</span>
  <span class="token key atrule">pipelineTriggers</span><span class="token punctuation">:</span>
    <span class="token comment"># 关联的事件源</span>
  <span class="token punctuation">-</span> <span class="token key atrule">eventSource</span><span class="token punctuation">:</span> webhook
    <span class="token comment"># 关联的流水线</span>
    <span class="token key atrule">pipeline</span><span class="token punctuation">:</span> pipeline<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>$suffix
</code></pre></div><p>替换变量后的文件示例如下：</p> <blockquote><p>您需要根据在上一章节选择的集群类型，将 Environment 资源的 <code>spec.cluster</code> 设置为的<a href="#%E6%B3%A8%E5%86%8C%E7%89%A9%E7%90%86%E9%9B%86%E7%BE%A4">物理集群名称</a>或<a href="#%E6%B3%A8%E5%86%8C%E8%99%9A%E6%8B%9F%E9%9B%86%E7%BE%A4">虚拟集群名称</a>。</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Environment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">cluster</span><span class="token punctuation">:</span> vcluster<span class="token punctuation">-</span>aliyun
  <span class="token key atrule">envType</span><span class="token punctuation">:</span> dev
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CodeRepoBinding
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">productName</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">name</span><span class="token punctuation">:</span> coderepobinding<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>pipeline<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">coderepo</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>deploy<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">projects</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> project<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">permissions</span><span class="token punctuation">:</span> readwrite
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> nautes.resource.nautes.io/v1alpha1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ProjectPipelineRuntime
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pr<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">product</span><span class="token punctuation">:</span> demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">project</span><span class="token punctuation">:</span> project<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">pipelineSource</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">pipelines</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pipeline<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
    <span class="token key atrule">label</span><span class="token punctuation">:</span> main
    <span class="token key atrule">path</span><span class="token punctuation">:</span> pipelines/main.yaml
  <span class="token key atrule">destination</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
  <span class="token key atrule">eventSources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> webhook
    <span class="token key atrule">gitlab</span><span class="token punctuation">:</span>
      <span class="token key atrule">repoName</span><span class="token punctuation">:</span> coderepo<span class="token punctuation">-</span>sc<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
      <span class="token key atrule">revision</span><span class="token punctuation">:</span> main
      <span class="token key atrule">events</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> push_events
  <span class="token key atrule">isolation</span><span class="token punctuation">:</span> exclusive
  <span class="token key atrule">pipelineTriggers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">eventSource</span><span class="token punctuation">:</span> webhook
    <span class="token key atrule">pipeline</span><span class="token punctuation">:</span> pipeline<span class="token punctuation">-</span>dev<span class="token punctuation">-</span>demo<span class="token punctuation">-</span>quickstart
</code></pre></div><p>下载 <a href="https://github.com/nautes-labs/cli/releases/tag/v0.3.0" target="_blank" rel="noopener noreferrer">命令行工具<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，执行以下命令，以初始化产品 。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token comment"># examples/demo-product.yaml 和 examples/demo-pipeline.yaml 指在代码库中模板文件的相对路径</span>
<span class="token comment"># gitlab-access-token 指 GitLab access token</span>
<span class="token comment"># api-server-address 指 Nautes API Server 的访问地址</span>
nautes apply <span class="token parameter variable">-f</span> examples/demo-product.yaml <span class="token parameter variable">-t</span> <span class="token variable">$gitlab</span>-access-token <span class="token parameter variable">-s</span> <span class="token variable">$api</span>-server-address
nautes apply <span class="token parameter variable">-f</span> examples/demo-pipeline.yaml <span class="token parameter variable">-t</span> <span class="token variable">$gitlab</span>-access-token <span class="token parameter variable">-s</span> <span class="token variable">$api</span>-server-address
</code></pre></div><p>在执行流水线之前，您需要先准备一个镜像仓库，用于存储流水线产生的容器镜像，下面将以 Github 的  <code>ghcr.io</code> 为例。</p> <p>您需要在 Github 上准备一个账号或组织，例如：<code>https://github.com/nautes-labs</code>，并在对此有权限的账号下生成一个具有 <code>write:packages</code> 权限的 <a href="https://docs.github.com/zh/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" target="_blank" rel="noopener noreferrer">personal access token<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>当运行时集群中与流水线运行时同名的命名空间就绪后，您需要在此命名空间下创建一个 ConfigMap 资源，流水线中的 <code>image-build</code> 任务在推送容器镜像时可以使用此 ConfigMap 通过镜像仓库的认证。</p> <p>ConfigMap 资源的模板位于相对路径 <code>examples/config.json</code> 下，您需要用以下命令生成的字符串替换其中的 <code>$auth</code> 变量：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># github-user 指您在 github 中的账号</span>
<span class="token comment"># github-token 指上述账号的 personal access token</span>
<span class="token builtin class-name">echo</span> <span class="token parameter variable">-n</span> <span class="token string">'$github-user:$github-token'</span> <span class="token operator">|</span> base64
</code></pre></div><p>替换变量后使用 <code>kubectl</code> 命令在运行时集群上创建 ConfigMap：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># pipeline-runtime-name 指流水线运行时名称，如：pr-demo-quickstart</span>
kubectl create configmap registry-auth --from-file<span class="token operator">=</span>config.json <span class="token parameter variable">-n</span> <span class="token variable">$pipeline</span>-runtime-name
</code></pre></div><h2 id="执行流水线"><a href="#执行流水线" class="header-anchor">#</a> 执行流水线</h2> <p>将示例项目的源码和流水线配置文件推送到“源码库”，将示例项目的 Kubernetes 资源清单（例如：deployment、service 等）提交至“部署配置库”。</p> <h3 id="提交部署清单"><a href="#提交部署清单" class="header-anchor">#</a> 提交部署清单</h3> <p>克隆部署示例的代码库到本地。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/nautes-examples/user-deployment.git
</code></pre></div><p>修改本地代码库中 Ingress 资源的域名：deployments/test/devops-sample-svc.yaml</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ks<span class="token punctuation">-</span>sample<span class="token punctuation">-</span>dev
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment"># 将 $cluster-ip 替换为运行时集群的公网 IP </span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> devops<span class="token punctuation">-</span>sample.$cluster<span class="token punctuation">-</span>ip.nip.io
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">...</span>
</code></pre></div><p>访问 <a href="/guide/user-guide/installation.html#查看安装结果">GitLab</a>，并设置 GitLab 账号具备<a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%A7%E5%93%81">部署配置库</a> main 分支的强制推送权限。详情参考<a href="https://docs.gitlab.com/ee/user/project/protected_branches.html#allow-force-push-on-a-protected-branch" target="_blank" rel="noopener noreferrer">保护分支启用强制推送<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>推送 Kubernetes 资源清单至部署配置库。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token comment"># 更改 origin 远程仓库为部署配置库，以下仓库地址仅为示例，需要将 $gitlab-url 替换为 Gitlab 的 IP 或域名</span>
<span class="token function">git</span> remote set-url origin git@<span class="token variable">$gitlab</span>-url:demo-quickstart/coderepo-deploy-demo-quickstart.git
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">'提交 Kubernetes 资源清单'</span>
<span class="token function">git</span> push origin main <span class="token parameter variable">-f</span>
</code></pre></div><h3 id="提交流水线配置"><a href="#提交流水线配置" class="header-anchor">#</a> 提交流水线配置</h3> <p>克隆流水线示例的代码库到本地。</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">git</span> clone https://github.com/nautes-examples/user-pipeline.git
</code></pre></div><p>替换本代码库中流水线配置文件 <code>pipelines/main.yaml</code> 中变量，包括：</p> <p><strong>$pipeline-runtime-name</strong> 替换为流水线运行时名称，如：<code>pr-demo-quickstart</code>。</p> <p><strong>$sc-repo-id</strong> 替换为源码库 ID，您可以从 Gitlab 控制台的 Project 首页中找到这个 ID。</p> <p><strong>$sc-repo-url</strong> 替换为源码库的 SSH URL，你可以 Gitlab 控制台的 Project 首页中找到这个 URL，如：<code>git@$gitlab-url:demo-quickstart/coderepo-sc-demo-quickstart.git</code>。</p> <p><strong>$deploy-repo-url</strong> 替换为部署配置库的 SSH URL，来源同上。</p> <p><strong>$registry-url</strong> 替换为容器镜像仓库的 URL，如：ghcr.io/nautes-labs。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> tekton.dev/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PipelineRun
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> main<span class="token punctuation">-</span>pipiline
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">params</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REVISION
    <span class="token key atrule">value</span><span class="token punctuation">:</span> main
  <span class="token key atrule">taskRunSpecs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">pipelineTaskName</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>clone<span class="token punctuation">-</span>sourcecode
    <span class="token key atrule">taskServiceAccountName</span><span class="token punctuation">:</span> nautes<span class="token punctuation">-</span>sa
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-pre-populate-only</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/tls-secret</span><span class="token punctuation">:</span> <span class="token string">&quot;ca&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/ca-cert</span><span class="token punctuation">:</span> <span class="token string">&quot;/vault/tls/ca.crt&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/role</span><span class="token punctuation">:</span> <span class="token string">'$pipeline-runtime-name'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-run-as-user</span><span class="token punctuation">:</span> <span class="token string">'0'</span> 
        <span class="token key atrule">vault.hashicorp.com/agent-run-as-group</span><span class="token punctuation">:</span> <span class="token string">'0'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject-secret-id_ecdsa</span><span class="token punctuation">:</span> <span class="token string">&quot;git/data/gitlab/repo-$sc-repo-id/default/readonly&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/secret-volume-path-id_ecdsa</span><span class="token punctuation">:</span> <span class="token string">&quot;/root/.ssh&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject-perms-id_ecdsa</span><span class="token punctuation">:</span> <span class="token string">'0400'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject-template-id_ecdsa</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          {{- with secret &quot;git/data/gitlab/repo-$sc-repo-id/default/readonly&quot; -}}
          {{ .Data.data.deploykey }}
          {{- end -}}</span>
  <span class="token punctuation">-</span> <span class="token key atrule">pipelineTaskName</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>clone<span class="token punctuation">-</span>deployment
    <span class="token key atrule">taskServiceAccountName</span><span class="token punctuation">:</span> nautes<span class="token punctuation">-</span>sa
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-pre-populate-only</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/tls-secret</span><span class="token punctuation">:</span> <span class="token string">&quot;ca&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/ca-cert</span><span class="token punctuation">:</span> <span class="token string">&quot;/vault/tls/ca.crt&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/role</span><span class="token punctuation">:</span> <span class="token string">'$pipeline-runtime-name'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-run-as-user</span><span class="token punctuation">:</span> <span class="token string">'0'</span> 
        <span class="token key atrule">vault.hashicorp.com/agent-run-as-group</span><span class="token punctuation">:</span> <span class="token string">'0'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject-secret-id_ecdsa</span><span class="token punctuation">:</span> <span class="token string">&quot;git/data/gitlab/repo-$sc-repo-id/default/readwrite&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/secret-volume-path-id_ecdsa</span><span class="token punctuation">:</span> <span class="token string">&quot;/root/.ssh&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject-perms-id_ecdsa</span><span class="token punctuation">:</span> <span class="token string">'0400'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject-template-id_ecdsa</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          {{- with secret &quot;git/data/gitlab/repo-$sc-repo-id/default/readwrite&quot; -}}
          {{ .Data.data.deploykey }}
          {{- end -}}</span>
  <span class="token punctuation">-</span> <span class="token key atrule">pipelineTaskName</span><span class="token punctuation">:</span> manifest<span class="token punctuation">-</span>update
    <span class="token key atrule">taskServiceAccountName</span><span class="token punctuation">:</span> nautes<span class="token punctuation">-</span>sa
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject</span><span class="token punctuation">:</span> <span class="token string">'true'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-pre-populate-only</span><span class="token punctuation">:</span> <span class="token string">&quot;true&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/tls-secret</span><span class="token punctuation">:</span> <span class="token string">&quot;ca&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/ca-cert</span><span class="token punctuation">:</span> <span class="token string">&quot;/vault/tls/ca.crt&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/role</span><span class="token punctuation">:</span> <span class="token string">'$pipeline-runtime-name'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-run-as-user</span><span class="token punctuation">:</span> <span class="token string">'0'</span> 
        <span class="token key atrule">vault.hashicorp.com/agent-run-as-group</span><span class="token punctuation">:</span> <span class="token string">'0'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject-secret-id_ecdsa</span><span class="token punctuation">:</span> <span class="token string">&quot;git/data/gitlab/repo-$sc-repo-id/default/readwrite&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/secret-volume-path-id_ecdsa</span><span class="token punctuation">:</span> <span class="token string">&quot;/root/.ssh&quot;</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject-perms-id_ecdsa</span><span class="token punctuation">:</span> <span class="token string">'0400'</span>
        <span class="token key atrule">vault.hashicorp.com/agent-inject-template-id_ecdsa</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          {{- with secret &quot;git/data/gitlab/repo-$sc-repo-id/default/readwrite&quot; -}}
          {{ .Data.data.deploykey }}
          {{- end -}}</span>
  <span class="token key atrule">pipelineSpec</span><span class="token punctuation">:</span>
    <span class="token key atrule">params</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> REVISION
        <span class="token key atrule">type</span><span class="token punctuation">:</span> string
        <span class="token key atrule">description</span><span class="token punctuation">:</span> Revision to checkout. (branch<span class="token punctuation">,</span> tag<span class="token punctuation">,</span> sha<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> etc<span class="token punctuation">...</span>)
        <span class="token key atrule">default</span><span class="token punctuation">:</span> <span class="token string">&quot;&quot;</span>
    <span class="token key atrule">tasks</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>clone<span class="token punctuation">-</span>sourcecode
      <span class="token key atrule">taskRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>clone
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterTask
      <span class="token key atrule">workspaces</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> output
        <span class="token key atrule">workspace</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>volume
      <span class="token key atrule">params</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> url
        <span class="token key atrule">value</span><span class="token punctuation">:</span> $sc<span class="token punctuation">-</span>repo<span class="token punctuation">-</span>url
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> revision
        <span class="token key atrule">value</span><span class="token punctuation">:</span> $(params.REVISION)
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> subdirectory
        <span class="token key atrule">value</span><span class="token punctuation">:</span> sourcecode
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>clone<span class="token punctuation">-</span>deployment
      <span class="token key atrule">runAfter</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> git<span class="token punctuation">-</span>clone<span class="token punctuation">-</span>sourcecode
      <span class="token key atrule">taskRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>clone
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterTask
      <span class="token key atrule">workspaces</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> output
        <span class="token key atrule">workspace</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>volume
      <span class="token key atrule">params</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> url
        <span class="token key atrule">value</span><span class="token punctuation">:</span> $deploy<span class="token punctuation">-</span>repo<span class="token punctuation">-</span>url
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> revision
        <span class="token key atrule">value</span><span class="token punctuation">:</span> $(params.REVISION)
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> subdirectory
        <span class="token key atrule">value</span><span class="token punctuation">:</span> deployment
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mvn<span class="token punctuation">-</span>build
      <span class="token key atrule">runAfter</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> git<span class="token punctuation">-</span>clone<span class="token punctuation">-</span>deployment
      <span class="token key atrule">taskRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> maven
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterTask
      <span class="token key atrule">workspaces</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> source
        <span class="token key atrule">workspace</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>volume
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> maven<span class="token punctuation">-</span>settings
        <span class="token key atrule">workspace</span><span class="token punctuation">:</span> empty<span class="token punctuation">-</span>dir
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> maven<span class="token punctuation">-</span>repository
        <span class="token key atrule">workspace</span><span class="token punctuation">:</span> maven<span class="token punctuation">-</span>repository<span class="token punctuation">-</span>volume
      <span class="token key atrule">params</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GOALS
        <span class="token key atrule">value</span><span class="token punctuation">:</span> 
          <span class="token punctuation">-</span> <span class="token punctuation">-</span>DskipTests
          <span class="token punctuation">-</span> clean
          <span class="token punctuation">-</span> install
          <span class="token punctuation">-</span> <span class="token punctuation">-</span>f
          <span class="token punctuation">-</span> sourcecode/pom.xml
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> image<span class="token punctuation">-</span>build
      <span class="token key atrule">runAfter</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> mvn<span class="token punctuation">-</span>build
      <span class="token key atrule">taskRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> kaniko
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterTask
      <span class="token key atrule">workspaces</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> source
        <span class="token key atrule">workspace</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>volume
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockerconfig
        <span class="token key atrule">workspace</span><span class="token punctuation">:</span> dockerconfig<span class="token punctuation">-</span>volume
      <span class="token key atrule">params</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> IMAGE
        <span class="token key atrule">value</span><span class="token punctuation">:</span> $registry<span class="token punctuation">-</span>url/devops<span class="token punctuation">-</span>sample<span class="token punctuation">:</span>0.0.1<span class="token punctuation">-</span>$(tasks.git<span class="token punctuation">-</span>clone<span class="token punctuation">-</span>sourcecode.results.commit)
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> DOCKERFILE
        <span class="token key atrule">value</span><span class="token punctuation">:</span> ./sourcecode/Dockerfile
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CONTEXT
        <span class="token key atrule">value</span><span class="token punctuation">:</span> ./sourcecode
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> manifest<span class="token punctuation">-</span>update
      <span class="token key atrule">runAfter</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> image<span class="token punctuation">-</span>build
      <span class="token key atrule">taskRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> git<span class="token punctuation">-</span>cli
        <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterTask
      <span class="token key atrule">workspaces</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> source
        <span class="token key atrule">workspace</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>volume
      <span class="token key atrule">params</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> BASE_IMAGE
        <span class="token key atrule">value</span><span class="token punctuation">:</span> gcr.io/tekton<span class="token punctuation">-</span>releases/github.com/tektoncd/pipeline/cmd/git<span class="token punctuation">-</span>init<span class="token punctuation">:</span>v0.29.0
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_USER_NAME
        <span class="token key atrule">value</span><span class="token punctuation">:</span> pipelinerobot
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_USER_EMAIL
        <span class="token key atrule">value</span><span class="token punctuation">:</span> pipelinerobot@nautes.io
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> GIT_SCRIPT
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          cd deployment
          sed -i -e &quot;s#ghcr.io/lanbingcloud/devops-sample.*#$(tasks.image-build.results.IMAGE_URL)#g&quot; deployments/test/devops-sample.yaml 
          git add deployments/test/devops-sample.yaml
          git commit -a -m &quot;automatic update by pipeline bot: $(tasks.image-build.results.IMAGE_URL)&quot;
          git push origin HEAD:$(params.REVISION) --force</span>
    <span class="token key atrule">workspaces</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>volume
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> empty<span class="token punctuation">-</span>dir
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> maven<span class="token punctuation">-</span>repository<span class="token punctuation">-</span>volume
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockerconfig<span class="token punctuation">-</span>volume
  <span class="token key atrule">workspaces</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> empty<span class="token punctuation">-</span>dir
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> source<span class="token punctuation">-</span>volume
    <span class="token key atrule">volumeClaimTemplate</span><span class="token punctuation">:</span>
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ReadWriteOnce
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 50M
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> maven<span class="token punctuation">-</span>repository<span class="token punctuation">-</span>volume
    <span class="token key atrule">volumeClaimTemplate</span><span class="token punctuation">:</span>
      <span class="token key atrule">spec</span><span class="token punctuation">:</span>
        <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> ReadWriteOnce
        <span class="token key atrule">resources</span><span class="token punctuation">:</span>
          <span class="token key atrule">requests</span><span class="token punctuation">:</span>
            <span class="token key atrule">storage</span><span class="token punctuation">:</span> 500M
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dockerconfig<span class="token punctuation">-</span>volume
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> registry<span class="token punctuation">-</span>auth
</code></pre></div><p>访问 <a href="/guide/user-guide/installation.html#查看安装结果">GitLab</a>，并设置 GitLab 账号具备<a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E4%BA%A7%E5%93%81">源码库</a> main 分支的强制推送权限。详情参考<a href="https://docs.gitlab.com/ee/user/project/protected_branches.html#allow-force-push-on-a-protected-branch" target="_blank" rel="noopener noreferrer">保护分支启用强制推送<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <p>推送流水线配置至源码库。</p> <div class="language-Shell extra-class"><pre class="language-shell"><code><span class="token comment"># 更改 origin 远程仓库为源码库，以下仓库地址仅为示例，需要将 $gitlab-url 替换为 Gitlab 的 IP 或域名</span>
<span class="token function">git</span> remote set-url origin git@<span class="token variable">$gitlab</span>-url:demo-quickstart/coderepo-sc-demo-quickstart.git
<span class="token function">git</span> <span class="token function">add</span> <span class="token builtin class-name">.</span>
<span class="token function">git</span> commit <span class="token parameter variable">-m</span> <span class="token string">'提交流水线配置'</span>
<span class="token function">git</span> push origin main <span class="token parameter variable">-f</span>
</code></pre></div><h2 id="查看流水线结果"><a href="#查看流水线结果" class="header-anchor">#</a> 查看流水线结果</h2> <h3 id="流水线"><a href="#流水线" class="header-anchor">#</a> 流水线</h3> <p>当您提交流水线配置到源码库后，Nautes 会响应代码库的 Webhook 回调，并在流水线运行时中声明的集群中触发流水线的执行。您可以使用浏览器访问 Tekton Dashboard 来查看流水线的执行情况，地址为：<code>http://$tekonHost:$traefik-httpsNodePort</code></p> <blockquote><p>替换变量 $tekonHost 为运行时集群的 tekonHost 字段的值，详情参考<a href="#%E6%B3%A8%E5%86%8C%E7%89%A9%E7%90%86%E9%9B%86%E7%BE%A4">注册物理集群</a>或者<a href="#%E6%B3%A8%E5%86%8C%E8%99%9A%E6%8B%9F%E9%9B%86%E7%BE%A4">注册虚拟集群</a>章节中属性模板的 <code>spec.tekonHost</code>，例如：<code>tekton.vcluster-aliyun.8.217.50.114.nip.io</code>。</p> <p>替换变量 $traefik-httpsNodePort 为运行时集群的 traefik 端口，详情参考<a href="#%E6%B3%A8%E5%86%8C%E7%89%A9%E7%90%86%E9%9B%86%E7%BE%A4">注册物理集群</a>或者<a href="#%E6%B3%A8%E5%86%8C%E8%99%9A%E6%8B%9F%E9%9B%86%E7%BE%A4">注册虚拟集群</a>章节中属性模板的 <code>spec.traefik.httpsNodePort</code>，例如：<code>30443</code>。</p></blockquote> <p>当您访问 Tekton Dashboard 时，如果在当前浏览器会话中未登录过 GitLab，访问动作会触发统一认证，认证过程中需要使用您的 GitLab 账号密码进行登录，登录成功后页面会自动跳转到 Tekton Dashboard。</p> <h3 id="镜像库"><a href="#镜像库" class="header-anchor">#</a> 镜像库</h3> <p>如果流水线已正常执行完成，您可以在镜像仓库（如：<code>https://github.com/orgs/nautes-labs/packages</code>）中看到新增的镜像信息，并可以通过类似下面的命令拉取镜像：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">docker</span> pull ghcr.io/nautes-labs/devops-sample:0.0.1-bdcdba83f17169db12e95bc9ff0592ace612016b
</code></pre></div><h3 id="部署清单"><a href="#部署清单" class="header-anchor">#</a> 部署清单</h3> <p>如果流水线已正常执行完成，您可以在部署配置库的 <code>deployments/test/devops-sample.yaml</code> 文件中看到容器的镜像标签已被自动修改为包含最新的 commitid，配置片段如下：</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ks<span class="token punctuation">-</span>sample
          <span class="token key atrule">image</span><span class="token punctuation">:</span> ghcr.io/nautes<span class="token punctuation">-</span>labs/devops<span class="token punctuation">-</span>sample<span class="token punctuation">:</span>0.0.1<span class="token punctuation">-</span>bdcdba83f17169db12e95bc9ff0592ace612016b
</code></pre></div><h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <p><strong>创建 ProjectPipelineRuntime 资源后，为什么 <code>argo-events</code> 命名空间中的某些 pods 状态为 <code>CrashLoopBackOff</code>，pods 日志显示 <code>too many open files</code> ？</strong></p> <p>当您创建了 ProjectPipelineRuntime 资源，并提交了流水线配置，如果您在访问 Tekton Dashboard 时发现流水线并未执行，同时，您在流水线运行时集群中，发现 <code>argo-events</code> 命名空间中的 pods 状态为 <code>CrashLoopBackOff</code>，pods 日志显示 <code>too many open files</code>。</p> <p>这是 Argo Events 的已知问题，您可以在 <a href="https://github.com/argoproj/argo-events/issues/1791" target="_blank" rel="noopener noreferrer">这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 查看更多详情。</p> <p>为了解决该问题，您需要在运行时集群所在的服务器上修改 <code>/etc/sysctl.conf</code> 文件中的 <code>fs.inotify.max_user_instances</code> 值为 <code>65535</code> ，然后重启服务器。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/guide/user-guide/installation.html" class="prev">
        安装
      </a></span> <span class="next"><a href="/guide/user-guide/deploy-an-application.html">
        部署一个应用
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fc750a70.js" defer></script><script src="/assets/js/2.5cda13a8.js" defer></script><script src="/assets/js/60.5faf93c2.js" defer></script>
  </body>
</html>
