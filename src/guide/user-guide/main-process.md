---
footerLink: /guide/user-guide/main-process
title: 主体流程
---
# 主体流程

本文档描述了部署一个应用的主体流程。包括以下步骤:  
[安装](#安装)  
[注册运行时集群](#注册运行时集群)  
[准备运行环境](#准备运行环境)  
[部署](#部署)  
[查看部署结果](#查看部署结果)  

主体流程如下图所示：

![directive syntax graph](./../images/user-guide-overview-1.png)

在 Nautes 中，租户管理集群和部署运行时集群是必不可少的组成部分。每个租户只有一个租户管理集群，负责初始化该租户的所有部署运行时集群，并协调各种组件，以向部署运行时集群实施自动化部署。每个租户只有一个存储在 GitLab 中的租户配置库，租户管理集群通过监听租户配置库，向其自动更新相关组件和资源。  
每个租户可以拥有多个部署运行时集群，这些部署运行时集群是承载IT系统运行时环境的真正载体，可以是虚拟集群或者物理集群。  

IT系统生命周期的不同阶段需要相应的环境，例如：开发、测试、预生产和生产环境。
环境需要在部署运行时集群上运行，因此必须将环境与部署运行时集群相关联，以便IT系统部署到正确的运行时环境中。  

在Nautes中，对于微服务架构的IT系统，“产品”表示一个IT系统，“项目”表示一个微服务。因此，一个产品包含多个项目，每个项目有独立的代码库。  
产品进行到一定阶段时需要验证或使用其特性，通常会根据部署配置向环境关联的部署运行时集群进行部署，以生成部署运行时环境。每个产品可以包含多个部署运行时环境，例如，使用相同部署配置在不同集群所创建出来的功能测试和客户演示环境。同时，在相同集群上也可以承载多个产品的部署运行时环境。    

Nautes 通过 Kubernetes 资源文件来定义环境、项目、代码库和部署运行时，并将这些资源文件存储到产品的 GitLab 代码库，资源文件的集合称为“产品配置清单”。Nautes 监听产品配置清单向部署运行时集群实施自动部署，创建或更新产品的部署运行时环境。  

当用户向部署运行时集群监听的 GitLab 代码库提交 Kubernetes 资源清单，产品的部署运行时环境监听 Kubernetes 资源清单并向部署运行时集群实施自动部署，直到部署运行时集群中的实际状态与 GitLab 代码库中的预期状态一致为止。  

为了保护敏感信息不被泄露，Nautes 中的敏感信息均通过 Vault 管理。    

## 安装
详情参考 [安装](installation.md)。

## 注册运行时集群
支持 [命令行](deploy-an-application.md#注册运行时集群) 和 [API](cluster.md) 两种方式注册运行时集群。

## 准备运行环境
提交产品配置清单支持 [命令行](deploy-an-application.md#准备运行环境) 和 API 两种方式。使用 API 接口的详细参见 [维护产品](product.md)、[维护项目](project.md)、[维护代码库](code-repo.md)、[维护环境](environment.md)、[维护部署运行时](deployment-runtime.md) 章节。  
提交产品配置清单有先后顺序。正向新增的顺序是：创建产品、创建环境、创建项目、创建代码库、创建部署运行时。反向销毁的顺序是：删除部署运行时、删除代码库、删除项目、删除环境、删除产品。  

产品创建成功后，将在 GitLab 中创建与产品同名的 group，并在这个 group 中创建名称为 `default.project` 的代码库，用于存储该产品的配置清单，包括环境、项目、代码库和部署运行时的资源文件。每个 group 有且只有一个 `default.project` 代码库。  

产品配置清单创建成功后，根据产品配置清单将在部署运行时集群中自动安装相关资源，使得部署运行时集群具备监听产品的 GitLab 代码库、并向该集群自动部署的能力。

> 为了保证 Nautes 基于产品配置清单能够自动部署产品的运行时环境，产品配置清单需要符合既定规则。因此，提交 API 请求时默认会对产品配置清单启用校验，如果校验不通过，则不能提交请求。
> 
> 在实际场景中，用户可能需要先提交不符合规则的资源文件，然后再补齐配套的资源。为了兼容类似场景，POST 和 DELETE 类型的 API 接口通过添加 `insecure_skip_check` 查询参数，并设置其属性值为 true，可以强制提交或删除资源文件。

## 部署
使用 Git CLI 向产品的 GitLab 代码库提交 Kubernetes 资源清单，例如：deployment、service 等资源。提交成功后，将向指定的部署运行时集群部署产品。详情参考 [部署](deploy-an-application.md#部署)。

## 查看部署结果  
可以通过 ArgoCD 控制台或者 kubectl 命令行查看产品的部署结果，并且只能查看和管理被授权产品的相关资源。详细参考 [查看部署结果](deployment-results.md)。