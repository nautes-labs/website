(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{336:function(a,t,s){"use strict";s.r(t);var e=s(14),r=Object(e.a)({},(function(){var a=this,t=a._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[t("h1",{attrs:{id:"安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[a._v("#")]),a._v(" 安装")]),a._v(" "),t("p",[a._v("Nautes 支持基于公有云、私有云、主机、及 Kubernets 集群进行安装，本文档以阿里云为例描述了在公有云安装 Nautes 的过程。")]),a._v(" "),t("h2",{attrs:{id:"准备环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#准备环境"}},[a._v("#")]),a._v(" 准备环境")]),a._v(" "),t("ul",[t("li",[a._v("安装机：AMD64 架构的 Linux 服务器，需要预先"),t("a",{attrs:{href:"https://docs.docker.com/engine/install/",target:"_blank",rel:"noopener noreferrer"}},[a._v("安装 Docker"),t("OutboundLink")],1),a._v("、Git、Bash，并确保 /opt/nautes 目录没有被占用。")]),a._v(" "),t("li",[a._v("公有云密钥：一个阿里云账号的访问密钥，如果您使用的是 RAM 用户，请确保 RAM 用户有 AliyunECSFullAccess 和 AliyunVPCFullAccess 权限。详情参考 "),t("a",{attrs:{href:"https://help.aliyun.com/document_detail/116401.html",target:"_blank",rel:"noopener noreferrer"}},[a._v("创建 AccessKey"),t("OutboundLink")],1),a._v("。")])]),a._v(" "),t("blockquote",[t("p",[a._v("安装程序会调用阿里云的 API 申请资源，这个过程会产生一定的费用（请参考 "),t("a",{attrs:{href:"#%E9%98%BF%E9%87%8C%E4%BA%91%E8%B4%B9%E7%94%A8%E8%AF%B4%E6%98%8E"}},[a._v("阿里云费用说明")]),a._v("）。")]),a._v(" "),t("p",[a._v("受阿里云的计费规则限制，请确保上述阿里云账号内的余额大于100元人民币，否则安装程序无法调用阿里云的 API 申请资源。")])]),a._v(" "),t("h2",{attrs:{id:"执行安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行安装"}},[a._v("#")]),a._v(" 执行安装")]),a._v(" "),t("blockquote",[t("p",[a._v("安装程序需要从 GitHub 获取相关配置（例如镜像等），请确保安装机与 GitHub 之间的网络连接正常。")])]),a._v(" "),t("p",[a._v("创建安装程序的配置文件。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("cat")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<<")]),t("span",{pre:!0,attrs:{class:"token string"}},[a._v("EOT"),t("span",{pre:!0,attrs:{class:"token bash punctuation"}},[a._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">>")]),a._v(" vars.yaml")]),a._v("\naccess_key: < your alicloud access key >\nsecret_key: < your alicloud secret key >\nEOT")]),a._v("\n")])])]),t("p",[a._v("执行以下命令进行默认安装。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" https://raw.githubusercontent.com/nautes-labs/installer/main/installer.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("bash")]),a._v(" -\n")])])]),t("p",[a._v("或者")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-OL")]),a._v(" https://raw.githubusercontent.com/nautes-labs/installer/main/installer.sh\n"),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("chmod")]),a._v(" +x installer.sh\n./installer.sh\n")])])]),t("blockquote",[t("p",[a._v("默认安装单节点的 K3s ，根据安装机公网带宽大小，整个安装过程预计耗时15~25分钟。安装成功后，您可以在 /opt/nautes 目录下找到安装后的组件信息。如果安装失败，您可以通过 /opt/nautes/out/logs 目录下的日志排查问题。")]),a._v(" "),t("p",[a._v("安装过程中出现任何问题，请参考 "),t("a",{attrs:{href:"#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98"}},[a._v("常见问题")]),a._v("。")])]),a._v(" "),t("h2",{attrs:{id:"查看安装结果"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#查看安装结果"}},[a._v("#")]),a._v(" 查看安装结果")]),a._v(" "),t("p",[a._v("/opt/nautes/flags 中存储了安装进度的标识文件。安装程序会根据标识文件跳过已完成的安装步骤。")]),a._v(" "),t("p",[a._v("/opt/nautes/terraform 中存储了 terraform 的状态文件，记录了安装程序在阿里云上申请的资源清单。")]),a._v(" "),t("p",[a._v("/opt/nautes/out 中存储了已安装组件的相关信息：")]),a._v(" "),t("ul",[t("li",[a._v("GitLab 用于托管租户的配置库，用户应用的源代码、部署清单和流水线配置等。GitLab 的管理员密码，以及租户配置库的访问信息等存储在 gitlab 子目录下。")]),a._v(" "),t("li",[a._v("Vault 用于存储和管理租户的密钥数据。Vault 的 unseal key 和 root token 存储在 vault 子目录下。")]),a._v(" "),t("li",[a._v("Kubernetes 集群用于承载所有的租户管理组件。集群的 kubeconfig 存储在 kubernetes 子目录下。")]),a._v(" "),t("li",[a._v("ArgoCD 用于监听租户配置库，并根据仓库中的配置声明向 Kubernetes 集群同步租户配置。ArgoCD 的管理员密码存储在 argocd 子目录下。")]),a._v(" "),t("li",[a._v("Dex 用于提供基于 OIDC 协议的统一认证服务。dex 的客户端密钥存储在 kubernetes 子目录下。")])]),a._v(" "),t("p",[a._v("除此之外，/opt/nautes/out 下其他子目录的相关信息：")]),a._v(" "),t("ul",[t("li",[a._v("hosts：云服务器的 IP 地址和访问密钥。")]),a._v(" "),t("li",[a._v("pki：访问组件需要使用的证书和签发证书的 CA。")]),a._v(" "),t("li",[a._v("service：租户管理集群、Dex、ArgoCD、Vault、GitLab、Nautes API Server 的访问地址。")]),a._v(" "),t("li",[a._v("logs：安装程序的日志。")])]),a._v(" "),t("blockquote",[t("p",[a._v("Nautes API Server 的 Swagger UI 相对路径：/q/swagger-ui。")]),a._v(" "),t("p",[a._v("租户配置库：用于存储租户管理相关的配置信息。每个租户有一个租户配置库。")])]),a._v(" "),t("h2",{attrs:{id:"销毁环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#销毁环境"}},[a._v("#")]),a._v(" 销毁环境")]),a._v(" "),t("blockquote",[t("p",[a._v("请确保未删除安装机上的 /opt/nautes 目录，并且执行销毁命令的目录下有安装程序的配置文件 vars.yaml。")]),a._v(" "),t("p",[a._v("销毁程序将删除所有从云服务中申请的资源，暂不支持单独对组件执行卸载。")])]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[a._v("curl")]),a._v(" https://raw.githubusercontent.com/nautes-labs/installer/main/installer.sh "),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("|")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[a._v("bash")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-s")]),a._v(" destroy\n")])])]),t("p",[a._v("或者")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[a._v("./installer.sh destroy\n")])])]),t("h2",{attrs:{id:"阿里云费用说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#阿里云费用说明"}},[a._v("#")]),a._v(" 阿里云费用说明")]),a._v(" "),t("p",[a._v("安装程序所申请的云服务器的默认规格如下：")]),a._v(" "),t("ul",[t("li",[a._v("区域：中国香港-可用区B")]),a._v(" "),t("li",[a._v("镜像：Ubuntu 22.04 64位")]),a._v(" "),t("li",[a._v("实例规格：ecs.c6.large(2C4G)")]),a._v(" "),t("li",[a._v("系统盘：ESSD云盘 PL0 40G")]),a._v(" "),t("li",[a._v("网络：实例公网IP")]),a._v(" "),t("li",[a._v("数目： 2")]),a._v(" "),t("li",[a._v("用途：K3s、Vault")])]),a._v(" "),t("hr"),a._v(" "),t("ul",[t("li",[a._v("区域：中国香港-可用区B")]),a._v(" "),t("li",[a._v("镜像：Ubuntu 22.04 64位")]),a._v(" "),t("li",[a._v("实例规格：ecs.g5.large(2C8G)")]),a._v(" "),t("li",[a._v("系统盘：ESSD云盘 PL0 40G")]),a._v(" "),t("li",[a._v("网络：实例公网IP")]),a._v(" "),t("li",[a._v("数目： 1")]),a._v(" "),t("li",[a._v("用途： GitLab")])]),a._v(" "),t("p",[a._v("安装程序默认使用 "),t("a",{attrs:{href:"https://help.aliyun.com/document_detail/52088.html?spm=5176.ecsbuyv3.0.0.2a2736756P0dh1",target:"_blank",rel:"noopener noreferrer"}},[a._v("抢占式实例模式"),t("OutboundLink")],1),a._v(" 创建云服务器，该模式存在实例被自动释放的风险。如果您希望体验更稳定的环境，请在 vars.yaml 增加以下配置，让安装程序切换至 "),t("a",{attrs:{href:"https://help.aliyun.com/document_detail/40653.html?spm=5176.ecsbuyv3.0.0.2a2736756P0dh1",target:"_blank",rel:"noopener noreferrer"}},[a._v("按量付费模式"),t("OutboundLink")],1),a._v(" 申请资源。")]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("alicloud.save_money")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token boolean important"}},[a._v("false")]),a._v("\n")])])]),t("p",[a._v("两种付费模式的费用预估如下（不包含流量费）：")]),a._v(" "),t("ul",[t("li",[t("p",[a._v("按量付费：56.1￥/天")])]),a._v(" "),t("li",[t("p",[a._v("抢占式实例：13.5￥/天")])])]),a._v(" "),t("blockquote",[t("p",[a._v("实际产生的费用会受到市场价格波动的影响，以上预估值仅供参考。")])]),a._v(" "),t("h2",{attrs:{id:"自定义安装"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自定义安装"}},[a._v("#")]),a._v(" 自定义安装")]),a._v(" "),t("h3",{attrs:{id:"使用指定版本的安装程序镜像"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用指定版本的安装程序镜像"}},[a._v("#")]),a._v(" 使用指定版本的安装程序镜像")]),a._v(" "),t("p",[a._v("安装开始前，设置环境变量 INSTALLER_VERSION。")]),a._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v("export")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[a._v("INSTALLER_VERSION")]),t("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("vX.Y.Z\n")])])]),t("h3",{attrs:{id:"使用指定租户配置库模板"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用指定租户配置库模板"}},[a._v("#")]),a._v(" 使用指定租户配置库模板")]),a._v(" "),t("p",[a._v("安装开始前，在 vars.yaml 文件中添加以下配置。")]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("repos.tenant_template.url")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" https"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v("//github.com/nautes"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("labs/tenant"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("repo"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("-")]),a._v("template.git\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("repos.tenant_template.version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" main\n")])])]),t("h3",{attrs:{id:"使用标准-k8s"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#使用标准-k8s"}},[a._v("#")]),a._v(" 使用标准 K8s")]),a._v(" "),t("p",[a._v("安装开始前，在 vars.yaml 文件中添加以下配置。")]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy.kubernetes.type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" k8s\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("deploy.kubernetes.node_num")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[a._v("3")]),a._v("\n")])])]),t("h3",{attrs:{id:"完整参数清单"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#完整参数清单"}},[a._v("#")]),a._v(" 完整参数清单")]),a._v(" "),t("p",[a._v("请参考 "),t("a",{attrs:{href:"https://github.com/nautes-labs/installer/blob/main/vars.yaml.sample",target:"_blank",rel:"noopener noreferrer"}},[a._v("vars.yaml.sample"),t("OutboundLink")],1),a._v("。")]),a._v(" "),t("h2",{attrs:{id:"常见问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#常见问题"}},[a._v("#")]),a._v(" 常见问题")]),a._v(" "),t("p",[t("strong",[a._v("安装 Nautes 过程中的步骤 [init-host : Create instance] 报错：code: 403, The resource is out of stock in the specified zone，应该怎么解决？")])]),a._v(" "),t("p",[a._v("安装程序默认使用 "),t("a",{attrs:{href:"https://help.aliyun.com/document_detail/52088.html?spm=5176.ecsbuyv3.0.0.2a2736756P0dh1",target:"_blank",rel:"noopener noreferrer"}},[a._v("抢占式实例模式"),t("OutboundLink")],1),a._v(" 创建指定规格的云服务器。")]),a._v(" "),t("p",[a._v("如果默认规格的云服务器库存不足，将出现以上错误。")]),a._v(" "),t("p",[a._v("查找报错信息中 "),t("code",[a._v('in resource "alicloud_instance"')]),a._v(" 之后的实例名称，例如：gitlab、kubernetes、vault。")]),a._v(" "),t("p",[a._v("根据不同的实例名称，在 "),t("code",[a._v("vars.yaml")]),a._v(" 文件中，按需添加对应参数以修改云服务器的默认规格。修改配置之后，请先"),t("a",{attrs:{href:"#%E9%94%80%E6%AF%81%E7%8E%AF%E5%A2%83"}},[a._v("销毁环境")]),a._v("，再重新"),t("a",{attrs:{href:"#%E6%89%A7%E8%A1%8C%E5%AE%89%E8%A3%85"}},[a._v("执行安装程序")]),a._v("即可解决该问题。")]),a._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# 以下参数值仅为建议实例类型，您可以修改实例类型为资源规格不低于建议实例类型的其他类型")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# GitLab 的云服务器实例类型")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("gitlab_instance_type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" ecs.g6.large\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Kubernetes 的云服务器实例类型")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("kubernetes_instance_type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" ecs.c5.large\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[a._v("# Vault 的云服务器实例类型")]),a._v("\n"),t("span",{pre:!0,attrs:{class:"token key atrule"}},[a._v("vault_instance_type")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(":")]),a._v(" ecs.c5.large\n")])])])])}),[],!1,null,null,null);t.default=r.exports}}]);